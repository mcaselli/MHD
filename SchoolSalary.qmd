---
title: "School Salary"
format: 
  html:
    embed-resources: true
---

```{r}
here::i_am("SchoolSalary.qmd")
library(here)
library(readxl)
library(tidyverse)
library(ggrepel)
library(gghighlight)
library(ggpubr)
library(scales)
```


{{< include read_and_process_data.qmd >}}


# municipalities in the teacher salary data that are not in the DOR data
```{r}
#find the sal that are not in inc
sal[!(sal$Municipality %in% inc$Municipality),] %>%
  arrange(desc(FTE.Count)) %>%
  DT::datatable(filter="top", rownames = FALSE)
```

# Educators by age group
```{r}
#plot age_long AgeGroup vs Count using ggplot
plot1 <- ggplot(age_long, aes(x = AgeGroup, y = Percent)) +
  geom_point(alpha = .01) +
  theme_minimal() +
  guides(fill="none")+
  #geom_point(data = age_long %>% filter(District.Name == "Marblehead"), aes(x = AgeGroup, y = Percent, color = ""#F8766D""))+
  geom_label(data = age_long %>% filter(District.Name == "Marblehead"), aes(label = round(Percent, digits = 2), x = AgeGroup, y = Percent), color = "#F8766D")+
  labs(x = "Age Group",
       y = "Proportion of Educators")+
    theme(legend.position="none")

ggsave(here("figures", "age.png"), plot1, width = 4, height = 2, units = "in")

plot1
```


# Average teacher salary vs per capita income
```{r}
#plot DOR.Income by Average.Salary using ggplot
plot2 <- ggplot(merged, aes(x = DOR.Income.Per.Capita, y = Average.Salary)) +
  geom_point(alpha = .5) +
  geom_smooth(method = "loess", se = FALSE, color = "#7CAE00") +
  theme_minimal()+
  geom_text_repel(data = merged %>% filter( !(Municipality == "Marblehead")), aes(label = Municipality), max.overlaps = 20, size = 3, segment.color = 'grey80') +
  geom_label_repel(data = merged %>% filter(Municipality == "Marblehead"), aes(label = Municipality), color = "#F8766D", position = position_nudge_repel(x =100, y =15))+
  geom_label_repel(data = merged %>% filter(Municipality == "Gloucester" |Municipality == "Beverly"), aes(label = Municipality), color = "#3B9AB2") +
  geom_point(data = merged %>% filter(Municipality == "Marblehead"), color = "#F8766D", size = 3) +
  geom_point(data = merged %>% filter(Municipality == "Gloucester" |Municipality == "Beverly"), color = "#00BFC4", size = 2) +
  scale_x_continuous(labels = scales::label_dollar()) +
  scale_y_continuous(labels = scales::label_dollar())+
  labs(x = "Per Capita Income",
       y = "Average Teacher Salary", 
       caption = "*DOR Income Per Capita represents the annual income as \nreported on annual tax returns divided by the US Census Population.")+
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0),
        axis.text=element_text(size=12),
        axis.title=element_text(size=18))

ggsave(here("figures", "sal.png"), plot2, width = 9, height = 9, units = "in")

plot2
```

```{r}
mhd_income_peers %>%
  arrange(desc(Average.Salary)) %>%
  select(Municipality, Average.Salary, contains("percentile"))
```
# Average teacher salary of Marblehead and its income peers
```{r}
#make a bar graph of the average salary of Marblehead and its income peers
plot3<- mhd_income_peers %>%
  mutate(FillCol = ifelse(Municipality == "Marblehead", "#00BFC4", "#F8766D")) %>%
  ggplot(aes(y = reorder(Municipality, Average.Salary), x = Average.Salary, fill = FillCol)) +
  geom_col() +
  theme_minimal() +
  labs(title = "Average Teacher Salary",
       y = "",
       x = "Average Teacher Salary",
       caption = "*Districts with per capita income rates \nsimilar to Marblehead (+/- 5 percentage points)") +
  geom_text(aes(label = scales::dollar(Average.Salary)), hjust = -0.1, size = 4)+
   guides(fill="none")+
   coord_cartesian(xlim = c(0, 150000)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=14),
        axis.title=element_text(size=18),
        title=element_text(size=18))
plot3
```
# Per capita income of Marblehead and its income peers
```{r}
#make a bar graph of per capita income of Marblehead and its income peers
plot4<- mhd_income_peers %>%
  mutate(FillCol = ifelse(Municipality == "Marblehead", "#00BFC4", "#F8766D")) %>%
  ggplot(aes(y = reorder(Municipality, DOR.Income.Per.Capita), x = DOR.Income.Per.Capita, fill = FillCol)) +
  geom_col() +
  theme_minimal() +
  labs(title = "Per Capita Income",
         y = "Municipality",
       x = "DOR Income Per Capita",
       caption = "*Districts with per capita income rates \nsimilar to Marblehead (+/- 5 percentage points)") +
  geom_text(aes(label = scales::dollar(DOR.Income.Per.Capita)), hjust = -0.1, size = 4)+
  guides(fill="none")+
  coord_cartesian(xlim = c(0, 260000)) +
  theme(plot.caption = element_text(color = "white"),axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.title=element_text(size=18),
        axis.text=element_text(size=14),
        title=element_text(size=18))
plot4
```
# composite chart, salary and income of Marblehead and its peers
```{r}
comp <- ggarrange( plot4, plot3, ncol = 2, nrow = 1, widths = c(.5, .5))
ggsave(here("figures", "comp.png"), comp, width = 12, height = 12, units = "in")
comp
```
# All Mass municipalities, tax receipts vs per capita income
```{r}
plot5 <- rev_inc %>%
   mutate(per_capita_receipts = Total.Receipts...9/Population) %>%
   ggplot(aes(x=DOR.Income.Per.Capita, y=per_capita_receipts, label=Municipality)) +
   geom_point(colour = "darkgrey", alpha = .5) +
   geom_label_repel(data = rev_inc %>% filter(Municipality == "Marblehead"), aes(label = Municipality), color = "#F8766D", position = position_nudge_repel(x =100, y =15))+
   geom_point(data = rev_inc %>% filter(Municipality == "Marblehead"), color = "#F8766D", size = 3) +
   scale_x_continuous(labels=label_dollar()) +
   scale_y_continuous(labels=label_dollar())+ 
   theme_minimal()+
   labs(x= "DOR Income Per Capita",
        y = "Taxes Per Capita")+
   theme(plot.caption.position = "plot",
         plot.caption = element_text(hjust = 0),
         axis.text=element_text(size=12),
         axis.title=element_text(size=18))
 
 ggsave(here("figures", "tax.png"), plot5, width = 6, height = 3, units = "in")
 plot5
```

# Average teacher salary vs per-capita tax receipts
```{r}
plot6<-  rev_inc_sal %>% 
  filter(per_capita_receipts < 12000) %>%
   ggplot(aes(x=per_capita_receipts, y=Average.Salary, label=Municipality)) +
   geom_point(colour = "darkgrey", alpha = .5) +
  #geom_text_repel(data = rev_inc_sal %>% filter( !(Municipality == "Marblehead")), aes(label = Municipality), max.overlaps = 5, size = 3, segment.color = 'grey80') +
  geom_label_repel(data = rev_inc_sal %>% filter(Municipality == "Marblehead"), aes(label = Municipality), color = "#F8766D")+
   geom_point(data = rev_inc_sal %>% filter(Municipality == "Marblehead"), color = "#F8766D", size = 3) +
   scale_x_continuous(labels=label_dollar(), limits = c(0, 15000)) +
   scale_y_continuous(labels=label_dollar())+ 
   theme_minimal()+
   labs(x= "Taxes Per Capita",
        y = "Average Teacher Salary")+
   theme(plot.caption.position = "plot",
         plot.caption = element_text(hjust = 0),
         axis.text=element_text(size=12),
         axis.title=element_text(size=18))
       
ggsave(here("figures", "taxsal.png"), plot6, width = 7, height = 3.5, units = "in")
plot6
```

```{r}
mhd_tax_peers
```
# Average teacher salary of marblehead and its tax peers
```{r}
#make a bar graph of the average salary of Marblehead and its tax peers
plot7<- mhd_tax_peers %>%
  mutate(FillCol = ifelse(Municipality == "Marblehead", "#00BFC4", "#F8766D")) %>%
  ggplot(aes(y = reorder(Municipality, Average.Salary), x = Average.Salary, fill = FillCol)) +
  geom_col() +
  theme_minimal() +
  labs(title = "Average Teacher Salary",
       y = "",
       x = "Average Teacher Salary",
       caption = "*Districts with per capita tax receipts \nsimilar to Marblehead (+/- 5 percentage points)") +
  geom_text(aes(label = scales::dollar(Average.Salary)), hjust = -0.1, size = 4)+
  guides(fill="none")+
  coord_cartesian(xlim = c(0, 150000)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text=element_text(size=14),
        axis.title=element_text(size=18),
        title=element_text(size=18))
plot7
```

```{r}
#make a bar graph of the average salary of Marblehead and its tax peers
plot8<- mhd_tax_peers %>%
  mutate(FillCol = ifelse(Municipality == "Marblehead", "#00BFC4", "#F8766D")) %>%
  ggplot(aes(y = reorder(Municipality, per_capita_receipts), x = per_capita_receipts, fill = FillCol)) +
  geom_col() +
  theme_minimal() +
   labs(title = "Per Capita Taxes",
        y = "Municipality",
        x = "Taxes Per Capita",
        caption = "*Districts with per capita tax receipts \nsimilar to Marblehead (+/- 5 percentage points)") +
  geom_text(aes(label = scales::dollar(per_capita_receipts)), hjust = -0.1, size = 4)+
  guides(fill="none")+
  coord_cartesian(xlim = c(0, 8000)) +
  theme(plot.caption = element_text(color = "white"),axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.title=element_text(size=18),
        axis.text=element_text(size=14),
        title=element_text(size=18))
plot8
```
```{r}
comp2 <- ggarrange( plot8, plot7, ncol = 2, nrow = 1, widths = c(.5, .5))
ggsave(here("figures", "taxsalpeers.png"), comp2, width = 12, height = 12, units = "in")
comp2
```

